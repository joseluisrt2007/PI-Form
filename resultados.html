<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="results">Resultados - Actividades de Mejora</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
    :root {
        --primary: #1a56db;
        --primary-dark: #1e429f;
        --primary-light: #3f83f8;
        --background-start: #f8fafc;
        --background-end: #f0f9ff;
        --text-dark: #1f2937;
        --text-light: #ffffff;
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 25px -5px rgba(59, 130, 246, 0.15);
        --card-shadow: 0 8px 30px rgba(0, 0, 0, 0.05);
        --section-bg: #ffffff;
        --accent-border: #3b82f6;
        --surface: #ffffff;
        --border: #e5e7eb;
        --card-bg: #ffffff;
        --header-bg: #1a56db;
        --list-bg: #f8fafc;
        --select-text: #1f2937;
        --select-bg: #ffffff;
        --select-border: #e5e7eb;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: 'Roboto', Arial, sans-serif;
        background: linear-gradient(135deg, var(--background-start) 0%, var(--background-end) 100%);
        min-height: 100vh;
        color: var(--text-dark);
        line-height: 1.5;
        display: flex;
        flex-direction: column;
    }

    header {
        background-color: var(--header-bg);
        color: var(--text-light);
        padding: 1.25rem 2rem;
        box-shadow: var(--shadow-sm);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1.5rem;
        font-weight: 500;
        position: relative;
        backdrop-filter: blur(10px);
    }

    .header-left {
        flex: 1;
        text-align: left;
    }

    .header-center {
        flex: 2;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .header-right {
        flex: 1;
        text-align: right;
    }

    .app-title {
        font-size: 1.5rem;
        font-weight: 500;
        margin-bottom: 0.25rem;
        letter-spacing: -0.5px;
    }

    .project-name-container {
        font-size: 1.125rem;
        font-weight: 400;
        opacity: 0.95;
        color: rgba(255, 255, 255, 0.9);
    }

    .language-selector select {
        padding: 10px 14px;
        border-radius: 12px;
        border: 2px solid var(--select-border);
        background-color: var(--select-bg);
        color: var(--select-text);
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 120px;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%231a56db' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 16px;
        padding-right: 40px;
    }

    .language-selector select:hover {
        border-color: var(--primary);
        background-color: var(--select-bg);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
    }

    .language-selector select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        background-color: var(--select-bg);
    }

    .language-selector select option {
        background-color: var(--select-bg);
        color: var(--select-text);
        padding: 12px;
        font-size: 0.9rem;
    }

    .language-selector select option:checked {
        background-color: rgba(59, 130, 246, 0.1);
        color: var(--primary);
        font-weight: 600;
    }

    main {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
    }

    .container {
        max-width: 1000px;
        width: 100%;
        padding: 3rem;
        background: var(--card-bg);
        border-radius: 20px;
        box-shadow: var(--card-shadow);
        text-align: center;
        border: 1px solid var(--border);
    }

    h1 {
        text-align: center;
        color: var(--primary-dark);
        font-size: 2.5rem;
        margin-bottom: 2.5rem;
        font-weight: 700;
        letter-spacing: -0.5px;
    }

    .success-message {
        font-size: 1.375rem;
        margin: 3rem 0;
        color: var(--primary);
        line-height: 1.6;
        font-weight: 500;
    }

    .pdf-info {
        font-size: 1.125rem;
        margin: 2.5rem 0;
        padding: 1.75rem;
        background: var(--list-bg);
        border-radius: 16px;
        border-left: 6px solid var(--accent-border);
        box-shadow: var(--shadow-sm);
    }

    .pdf-info strong {
        font-weight: 600;
        color: var(--primary-dark);
    }

    .pdf-info button {
        margin-top: 1.5rem;
    }

    .buttons {
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        margin-top: 3.5rem;
        flex-wrap: wrap;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-light), var(--primary));
        color: var(--text-light);
        padding: 1.125rem 3rem;
        border: none;
        border-radius: 16px;
        font-size: 1.25rem;
        font-weight: 600;
        cursor: pointer;
        box-shadow: var(--shadow-lg);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        transform: translateY(-6px);
        box-shadow: 0 20px 40px rgba(59, 130, 246, 0.4);
    }

    .btn-primary:focus-visible {
        outline: 4px solid rgba(59, 130, 246, 0.5);
        outline-offset: 6px;
    }

    .btn-primary:active {
        transform: translateY(-2px);
    }

    .btn-secondary {
        background: linear-gradient(135deg, #6b7280, #4b5563);
    }

    .btn-secondary:hover {
        background: linear-gradient(135deg, #4b5563, #374151);
        transform: translateY(-6px);
    }

    footer {
        padding: 2rem;
        text-align: center;
        font-size: 0.875rem;
        color: #666;
        background-color: var(--background-end);
        margin-top: auto;
    }

    .header-controls {
        display: flex;
        align-items: center;
        gap: 15px;
        justify-content: flex-end;
    }

    .theme-toggle {
        background: transparent;
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        padding: 0;
        backdrop-filter: blur(10px);
    }

    .theme-toggle:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.5);
        transform: rotate(15deg) scale(1.05);
    }

    .theme-toggle:active {
        transform: scale(0.95);
    }

    [data-theme="dark"] {
        --primary: #3b82f6;
        --primary-dark: #2563eb;
        --primary-light: #60a5fa;
        --background-start: #0f172a;
        --background-end: #1e293b;
        --text-dark: #f1f5f9;
        --text-light: #ffffff;
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.5);
        --shadow-lg: 0 10px 25px -5px rgba(30, 64, 175, 0.3);
        --card-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        --section-bg: #1e293b;
        --accent-border: #3b82f6;
        --surface: #1e293b;
        --border: #475569;
        --card-bg: #1e293b;
        --header-bg: #1e293b;
        --list-bg: #2d3748;
        --select-text: #f1f5f9;
        --select-bg: #2d3748;
        --select-border: #475569;
    }

    [data-theme="dark"] body {
        background: linear-gradient(135deg, var(--background-start) 0%, var(--background-end) 100%);
        color: var(--text-dark);
    }

    [data-theme="dark"] header {
        background-color: var(--header-bg);
        border-bottom: 1px solid var(--border);
        box-shadow: var(--shadow-sm);
        backdrop-filter: blur(10px);
    }

    [data-theme="dark"] .project-name-container {
        color: #cbd5e1;
    }

    [data-theme="dark"] .language-selector select {
        border-color: var(--select-border);
        background-color: var(--select-bg);
        color: var(--select-text);
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
    }

    [data-theme="dark"] .language-selector select:hover {
        border-color: var(--primary-light);
        background-color: #374151;
        box-shadow: 0 4px 12px rgba(30, 64, 175, 0.2);
    }

    [data-theme="dark"] .language-selector select:focus {
        border-color: var(--primary-light);
        box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.3);
        background-color: #374151;
    }

    [data-theme="dark"] .language-selector select option {
        background-color: #2d3748;
        color: #f1f5f9;
    }

    [data-theme="dark"] .language-selector select option:checked {
        background-color: rgba(59, 130, 246, 0.2);
        color: #60a5fa;
    }

    [data-theme="dark"] .container {
        background: var(--card-bg);
        border: 1px solid var(--border);
        box-shadow: var(--card-shadow);
    }

    [data-theme="dark"] h1 {
        color: var(--text-light);
    }

    [data-theme="dark"] .success-message {
        color: var(--primary-light);
    }

    [data-theme="dark"] .pdf-info {
        background: var(--list-bg);
        border-left-color: var(--accent-border);
    }

    [data-theme="dark"] .pdf-info strong {
        color: var(--primary-light);
    }

    [data-theme="dark"] .btn-primary {
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    }

    [data-theme="dark"] .btn-primary:hover {
        background: linear-gradient(135deg, var(--primary-dark), #1e40af);
    }

    [data-theme="dark"] .btn-secondary {
        background: linear-gradient(135deg, #4b5563, #374151);
    }

    [data-theme="dark"] .btn-secondary:hover {
        background: linear-gradient(135deg, #374151, #1f2937);
    }

    [data-theme="dark"] .theme-toggle {
        border-color: rgba(96, 165, 250, 0.3);
        background: rgba(59, 130, 246, 0.1);
        color: #60a5fa;
    }

    [data-theme="dark"] .theme-toggle:hover {
        background: rgba(59, 130, 246, 0.2);
        border-color: rgba(96, 165, 250, 0.6);
    }

    [data-theme="dark"] footer {
        background-color: #1e293b;
        color: #cbd5e1;
        border-top: 1px solid var(--border);
    }

    @media (max-width: 768px) {
        header {
            flex-direction: column;
            gap: 1rem;
            padding: 1.25rem 1rem;
            font-size: 1.3rem;
            text-align: center;
        }

        .header-left,
        .header-center,
        .header-right {
            width: 100%;
            text-align: center;
        }

        .header-left {
            order: 1;
        }

        .header-center {
            order: 3;
            margin-top: 0.5rem;
        }

        .header-right {
            order: 2;
        }

        .app-title {
            font-size: 1.3rem;
        }

        .project-name-container {
            font-size: 1rem;
        }

        .language-selector select {
            min-width: 100px;
            padding: 8px 12px;
        }

        main {
            padding: 1rem;
        }

        .container {
            padding: 2rem;
            border-radius: 16px;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 2rem;
        }

        .success-message {
            font-size: 1.25rem;
            margin: 2rem 0;
        }

        .pdf-info {
            font-size: 1rem;
            padding: 1.25rem;
            margin: 2rem 0;
        }

        .buttons {
            flex-direction: column;
            align-items: center;
            margin-top: 3rem;
            gap: 1rem;
        }

        .btn-primary,
        .btn-secondary {
            width: 100%;
            max-width: 350px;
            font-size: 1.125rem;
            padding: 1rem 2rem;
        }

        .header-controls {
            flex-direction: row;
            gap: 15px;
            justify-content: center;
        }
        
        .theme-toggle {
            order: 1;
        }
        
        .language-selector {
            order: 2;
        }
        
        .theme-toggle {
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
        }
    }

    @media (max-width: 480px) {
        .app-title {
            font-size: 1.2rem;
        }
        
        .project-name-container {
            font-size: 0.95rem;
        }
        
        .language-selector select {
            padding: 6px 10px;
            font-size: 0.85rem;
            min-width: 90px;
        }

        h1 {
            font-size: 1.8rem;
        }

        .success-message {
            font-size: 1.125rem;
        }

        .pdf-info {
            padding: 1rem;
        }

        .header-controls {
            gap: 10px;
        }
        
        .theme-toggle {
            width: 38px;
            height: 38px;
            font-size: 1.1rem;
        }
    }
</style>
<script src="lang.js"></script>
</head>
<body>
    <header role="banner">
    <div class="header-left">
        <!-- Espacio reservado para alineaciÃ³n -->
    </div>
    
    <div class="header-center">
        <div class="app-title" data-i18n="app_title">Desarrollo de Formularios para Actividades de Mejora</div>
        <div class="project-name-container" id="projectNameDisplay">
            <span data-i18n="project">Proyecto:</span> <span id="projectNameText">(Sin nombre)</span>
        </div>
    </div>
    
    <div class="header-right">
        <div class="header-controls">
            <button class="theme-toggle" id="themeToggle" title="Cambiar tema">
                ðŸŒ™
            </button>
            <div class="language-selector">
                <select id="languageSelector">
                    <option value="es">ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
                    <option value="en">ðŸ‡ºðŸ‡¸ English</option>
                </select>
            </div>
        </div>
    </div>
    </header>

    <main>
        <div class="container">
            <h1 data-i18n="report_generated">Â¡Informe generado con Ã©xito!</h1>

        <div class="success-message" data-i18n="pdf_download_info">
            El informe PDF de su proyecto ha sido generado y descargado automÃ¡ticamente.<br>
            Puede encontrarlo en la carpeta de descargas de su navegador.
        </div>

        <div class="pdf-info">
           <strong data-i18n="pdf_filename">Nombre del archivo:</strong> <span id="filenameDisplay"></span><br><br>
           <button class="btn-primary" id="downloadAgainBtn" data-i18n="download_pdf">Descargar PDF nuevamente</button>
        </div>

        <div class="buttons">
            <button class="btn-primary btn-secondary" onclick="window.location.href='index.html'" data-i18n="return_main_menu">Volver al menÃº principal</button>
        </div>
        </div>
    </main>
    

    <script>
        const data = JSON.parse(localStorage.getItem('projectData') || '{}');
    
            // Configurar selector de idioma
            document.addEventListener('DOMContentLoaded', function() {
               const langSelector = document.getElementById('languageSelector');
               if (langSelector) {
                   const currentLang = localStorage.getItem('preferredLanguage') || 'es';
                   langSelector.value = currentLang;
            
                   langSelector.addEventListener('change', function() {
                       setLanguage(this.value);
                       updateProjectName();
                   });
                }
        
                updateProjectName();
            });

            // Actualizar nombre del proyecto en navbar
            function updateProjectName() {
                const projectText = document.getElementById('projectNameText');
        
                if (data.projectName && data.projectName.trim()) {
                    projectText.textContent = data.projectName;
             } else {
                   // Usar traducciÃ³n para "(Sin nombre)"
                    projectText.textContent = t('unnamed_project');
                }
            }

            let pdfBlob = null;
            let filename = `informe_${(data.projectName || 'proyecto').replace(/ /g, '_')}.pdf`;


        function generarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
    
            let y = 20;
            const margen = 20;
            const anchoPagina = doc.internal.pageSize.width;

            // Determinar idioma actual
            const currentLang = localStorage.getItem('preferredLanguage') || 'es';
            const isSpanish = currentLang === 'es';
    
            // Funciones de traducciÃ³n para el PDF
            const t = (key) => {
                const translations = {
                    'es': {
                        'complete_project_report': 'INFORME COMPLETO DE PROYECTO',
                        'generated_on': 'Generado el:',
                        'criteria_weights': '1. CRITERIOS Y PESOS',
                        'criteria': 'Criterio',
                        'weight': 'Peso',
                        'total_sum_weights': 'SUMA TOTAL DE PESOS:',
                        'ideas_concepts': '2. IDEAS / CONCEPTOS INICIALES',
                        'idea': 'Idea',
                        'initial_evaluation': '3. EVALUACIÃ“N INICIAL DE IDEAS',
                        'no_initial_data': 'No hay datos de evaluaciÃ³n inicial',
                        'for': 'Para',
                        'option': 'OpciÃ³n',
                        'explore_possibilities': '4. EXPLORACIÃ“N DE POSIBILIDADES',
                        'no_possibilities_data': 'No hay datos de exploraciÃ³n de posibilidades',
                        'concept_formation': '5. FORMACIÃ“N DE CONCEPTOS',
                        'checkbox_selections': '(Selecciones realizadas con checkboxes)',
                        'selection_summary': 'Resumen de selecciones por grupo:',
                        'group': 'Grupo',
                        'from': 'de',
                        'no_selections': 'No hay selecciones realizadas',
                        'concepts_formed': '6. CONCEPTOS FORMADOS',
                        'concepts_from_selections': '(Los 3 conceptos creados a partir de las selecciones)',
                        'concept_formed': 'Concepto Formado',
                        'no_selection': '(Sin selecciÃ³n)',
                        'no_concepts_formed': 'No se han formado conceptos',
                        'evaluation_concepts_formed': '7. EVALUACIÃ“N DE CONCEPTOS FORMADOS',
                        'no_evaluation_concepts': 'No hay evaluaciÃ³n de conceptos formados',
                        'final_score': 'PuntuaciÃ³n final:',
                        'best_concept_selected': '8. MEJOR CONCEPTO SELECCIONADO',
                        'score_obtained': 'PuntuaciÃ³n obtenida:',
                        'composition_winner': 'COMPOSICIÃ“N DEL CONCEPTO GANADOR:',
                        'idea_not_selected': '(Idea no seleccionada)',
                        'no_best_concept': 'No hay concepto evaluado como mejor',
                        'risk_prevention': '9. PREVENCIÃ“N DE RIESGOS',
                        'prevention': 'PREVENCIÃ“N',
                        'potential_failure': 'â€¢ Falla potencial:',
                        'effect': 'â€¢ Efecto:',
                        'severity': 'â€¢ Severidad (1-10):',
                        'occurrence': 'â€¢ Ocurrencia (1-10):',
                        'risk': 'â€¢ Riesgo calculado:',
                        'actions_to_take': 'â€¢ AcciÃ³n/Acciones a realizar:',
                        'responsible': 'â€¢ Responsable:',
                        'today_date': 'â€¢ Fecha de hoy:',
                        'action_taken': 'â€¢ AcciÃ³n tomada:',
                        'action_date': 'â€¢ Fecha de realizaciÃ³n:',
                        'no_prevention_data': 'No hay datos de prevenciÃ³n de riesgos',
                        'action_plan': '10. PLAN DE ACCIÃ“N',
                        'tasks_1_15': 'Tareas 1-15:',
                        'tasks_16_30': 'Tareas 16-30:',
                        'no_tasks': 'No hay tareas en el plan',
                        'document_generated': 'Documento generado el'
                    },
                    'en': {
                        'complete_project_report': 'COMPLETE PROJECT REPORT',
                        'generated_on': 'Generated on:',
                        'criteria_weights': '1. CRITERIA AND WEIGHTS',
                        'criteria': 'Criteria',
                        'weight': 'Weight',
                        'total_sum_weights': 'TOTAL SUM OF WEIGHTS:',
                        'ideas_concepts': '2. INITIAL IDEAS / CONCEPTS',
                        'idea': 'Idea',
                        'initial_evaluation': '3. INITIAL EVALUATION OF IDEAS',
                        'no_initial_data': 'No initial evaluation data',
                        'for': 'For',
                        'option': 'Option',
                        'explore_possibilities': '4. EXPLORATION OF POSSIBILITIES',
                        'no_possibilities_data': 'No exploration of possibilities data',
                        'concept_formation': '5. CONCEPT FORMATION',
                        'checkbox_selections': '(Selections made with checkboxes)',
                        'selection_summary': 'Selection summary by group:',
                        'group': 'Group',
                        'from': 'from',
                        'no_selections': 'No selections made',
                        'concepts_formed': '6. FORMED CONCEPTS',
                        'concepts_from_selections': '(The 3 concepts created from the selections)',
                        'concept_formed': 'Concept Formed',
                        'no_selection': '(No selection)',
                        'no_concepts_formed': 'No concepts have been formed',
                        'evaluation_concepts_formed': '7. EVALUATION OF FORMED CONCEPTS',
                        'no_evaluation_concepts': 'No evaluation of formed concepts',
                        'final_score': 'Final score:',
                        'best_concept_selected': '8. BEST CONCEPT SELECTED',
                        'score_obtained': 'Score obtained:',
                        'composition_winner': 'COMPOSITION OF THE WINNING CONCEPT:',
                        'idea_not_selected': '(Idea not selected)',
                        'no_best_concept': 'No concept evaluated as best',
                        'risk_prevention': '9. RISK PREVENTION',
                        'prevention': 'PREVENTION',
                        'potential_failure': 'â€¢ Potential failure:',
                        'effect': 'â€¢ Effect:',
                        'severity': 'â€¢ Severity (1-10):',
                        'occurrence': 'â€¢ Occurrence (1-10):',
                        'risk': 'â€¢ Calculated risk:',
                        'actions_to_take': 'â€¢ Action/Actions to take:',
                        'responsible': 'â€¢ Responsible:',
                        'today_date': 'â€¢ Today\'s date:',
                        'action_taken': 'â€¢ Action taken:',
                        'action_date': 'â€¢ Date of execution:',
                        'no_prevention_data': 'No risk prevention data',
                        'action_plan': '10. ACTION PLAN',
                        'tasks_1_15': 'Tasks 1-15:',
                        'tasks_16_30': 'Tasks 16-30:',
                        'no_tasks': 'No tasks in the plan',
                        'document_generated': 'Document generated on'
                    }
                };
        
                return translations[currentLang][key] || key;
            };

            // 1. PORTADA
            doc.setFontSize(24);
            doc.setTextColor(21, 101, 192);
            doc.setFont("helvetica", "bold");
            doc.text(t('complete_project_report'), anchoPagina / 2, 80, { align: "center" });

            doc.setFontSize(18);
            doc.setTextColor(0, 0, 0);
            doc.setFont("helvetica", "normal");
            doc.text(data.projectName || (isSpanish ? "Proyecto sin nombre" : "Unnamed project"), anchoPagina / 2, 110, { align: "center" });

            const hoy = new Date().toLocaleDateString(isSpanish ? 'es-ES' : 'en-US');
            doc.setFontSize(14);
            doc.setTextColor(100, 100, 100);
            doc.text(`${t('generated_on')} ${hoy}`, anchoPagina / 2, 130, { align: "center" });

            // Nueva pÃ¡gina para contenido
            doc.addPage();
            y = margen;

            // 2. CRITERIOS Y PESOS
            doc.setFontSize(16);
            doc.setTextColor(21, 101, 192);
            doc.setFont("helvetica", "bold");
            doc.text(t('criteria_weights'), margen, y);
            y += 15;

            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.setFont("helvetica", "normal");

            let sumaPesos = 0;
            for (let i = 1; i <= 4; i++) {
                const criterio = data[`criterio${i}`] || `${t('criteria')} ${i}`;
                const peso = parseFloat(data[`peso${i}`]) || 0;
                sumaPesos += peso;

                doc.text(`${i}. ${criterio}`, margen, y);
                doc.text(`${t('weight')}: ${peso.toFixed(1)}`, margen + 100, y);
                y += 10;

                if (y > 280) {
                    doc.addPage();
                    y = margen;
                }
            }

            doc.setFont("helvetica", "bold");
            doc.text(`${t('total_sum_weights')} ${sumaPesos.toFixed(1)}`, margen, y);
            y += 15;
            doc.setFont("helvetica", "normal");

            y += 10;

            // 3. IDEAS / CONCEPTOS INICIALES
            if (y > 250) {
                doc.addPage();
                y = margen;
            }

            doc.setFontSize(16);
            doc.setTextColor(21, 101, 192);
            doc.setFont("helvetica", "bold");
            doc.text(t('ideas_concepts'), margen, y);
            y += 15;

            for (let i = 1; i <= 5; i++) {
                const concepto = data[`concepto${i}`] || `${t('idea')} ${i}`;
                doc.text(`${i}. ${concepto}`, margen, y);
                y += 10;

                if (y > 280) {
                    doc.addPage();
                    y = margen;
                }
            }

            y += 10;

            // 4. EVALUACIÃ“N INICIAL DE IDEAS
            if (y > 220) {
                doc.addPage();
                y = margen;
            }

            doc.setFontSize(16);
            doc.setTextColor(21, 101, 192);
            doc.setFont("helvetica", "bold");
            doc.text(t('initial_evaluation'), margen, y);
            y += 15;

            // Verificar si hay datos de evaluaciÃ³n inicial
            let tieneEvaluacionInicial = false;
            for (let conc = 1; conc <= 5; conc++) {
                for (let i = 1; i <= 4; i++) {
                    if (data[`calif${conc}_${i}`]) {
                        tieneEvaluacionInicial = true;
                        break;
                    }
                }
                if (tieneEvaluacionInicial) break;
            }

            if (tieneEvaluacionInicial) {
                for (let conc = 1; conc <= 5; conc++) {
                    if (y > 240) {
                        doc.addPage();
                        y = margen;
                    }

                    doc.setFontSize(14);
                    doc.setTextColor(13, 71, 161);
                    doc.setFont("helvetica", "bold");
                    doc.text(`${t('idea')} ${conc}: ${data[`concepto${conc}`] || `${t('idea')} ${conc}`}`, margen, y);
                    y += 12;

                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont("helvetica", "normal");

                    let total = 0;
                    let tieneDatos = false;

                    for (let i = 1; i <= 4; i++) {
                        const calif = parseFloat(data[`calif${conc}_${i}`]) || 0;
                        const peso = parseFloat(data[`peso${i}`]) || 0;

                        if (data[`calif${conc}_${i}`]) {
                            tieneDatos = true;
                            const ponderado = calif * peso;
                            total += ponderado;

                            const criterio = data[`criterio${i}`] || `${t('criteria')} ${i}`;
                            doc.text(`  ${criterio}: ${calif.toFixed(1)} Ã— ${peso.toFixed(1)} = ${ponderado.toFixed(2)}`, margen + 10, y);
                            y += 8;

                            if (y > 280) {
                                doc.addPage();
                                y = margen;
                            }
                        }
                    }

                    if (tieneDatos) {
                        doc.setFont("helvetica", "bold");
                        doc.text(`  TOTAL: ${total.toFixed(2)}`, margen + 10, y);
                        doc.setFont("helvetica", "normal");
                        y += 12;
                    }

                    y += 10;
                }
            } else {
                doc.text(t('no_initial_data'), margen, y);
                y += 10;
            }

            y += 10;

            // 5. EXPLORACIÃ“N DE POSIBILIDADES
            if (y > 200) {
                doc.addPage();
                y = margen;
            }

            doc.setFontSize(16);
            doc.setTextColor(21, 101, 192);
            doc.setFont("helvetica", "bold");
            doc.text(t('explore_possibilities'), margen, y);
            y += 15;

            // Verificar si hay datos de posibilidades
            let tienePosibilidades = false;
            for (let i = 1; i <= 15; i++) {
                if (data[`pos${i}`]) {
                    tienePosibilidades = true;
                    break;
                }
            }

            if (tienePosibilidades) {
                for (let conc = 1; conc <= 5; conc++) {
                    if (y > 250) {
                        doc.addPage();
                        y = margen;
                    }

                    doc.setFontSize(14);
                    doc.setTextColor(13, 71, 161);
                    doc.setFont("helvetica", "bold");
                    doc.text(`${t('for')} ${data[`concepto${conc}`] || `${t('idea')} ${conc}`}`, margen, y);
                    y += 12;

                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont("helvetica", "normal");

                    for (let row = 1; row <= 3; row++) {
                        const posIdx = (conc - 1) * 3 + row;
                        const posibilidad = data[`pos${posIdx}`] || "";

                        if (posibilidad) {
                            doc.text(`  ${t('option')} ${row}: ${posibilidad}`, margen + 10, y);
                            y += 8;

                            if (y > 280) {
                                doc.addPage();
                                y = margen;
                            }
                        }
                    }

                    y += 10;
                }
            } else {
                doc.text(t('no_possibilities_data'), margen, y);
                y += 10;
            }

            y += 10;

            // 6. FORMACIÃ“N DE CONCEPTOS
            if (y > 200) {
                doc.addPage();
                y = margen;
            }

            doc.setFontSize(16);
            doc.setTextColor(21, 101, 192);
            doc.setFont("helvetica", "bold");
            doc.text(t('concept_formation'), margen, y);
            y += 15;

            doc.setFontSize(12);
            doc.setTextColor(80, 80, 80);
            doc.text(t('checkbox_selections'), margen, y);
            y += 10;

            // Verificar si hay selecciones
            let tieneSelecciones = false;
            for (let i = 1; i <= 15; i++) {
                if (data[`pastel_grupo${i}`]) {
                    tieneSelecciones = true;
                    break;
                }
            }

            if (tieneSelecciones) {
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);

                // Mostrar tabla de selecciones
                doc.text(t('selection_summary'), margen, y);
                y += 10;

                for (let i = 1; i <= 15; i++) {
                    const seleccion = data[`pastel_grupo${i}`];
                    if (seleccion) {
                        // Determinar a quÃ© idea original pertenece
                        const ideaOriginal = Math.ceil(i / 3);
                        const nombreIdea = data[`concepto${ideaOriginal}`] || `${t('idea')} ${ideaOriginal}`;

                        doc.text(`  ${t('group')} ${i} (${t('from')} ${nombreIdea}): ${seleccion}`, margen + 10, y);
                        y += 8;

                        if (y > 280) {
                            doc.addPage();
                            y = margen;
                        }
                    }
                }
            } else {
                doc.text(t('no_selections'), margen, y);
                y += 10;
            }

            y += 15;

            // 7. CONCEPTOS FORMADOS (3 conceptos de 5 ideas)
            if (y > 220) {
                doc.addPage();
                y = margen;
            }

            doc.setFontSize(16);
            doc.setTextColor(21, 101, 192);
            doc.setFont("helvetica", "bold");
            doc.text(t('concepts_formed'), margen, y);
            y += 15;

            doc.setFontSize(12);
            doc.setTextColor(80, 80, 80);
            doc.text(t('concepts_from_selections'), margen, y);
            y += 10;

            // Los 3 conceptos formados
            const conceptosFormados = [
                { nombre: t('concept_formed') + " 1", grupos: [1, 4, 7, 10, 13] },
                { nombre: t('concept_formed') + " 2", grupos: [2, 5, 8, 11, 14] },
                { nombre: t('concept_formed') + " 3", grupos: [3, 6, 9, 12, 15] }
            ];

            let tieneConceptos = false;

            for (const concepto of conceptosFormados) {
                if (y > 240) {
                    doc.addPage();
                    y = margen;
                }

                doc.setFontSize(14);
                doc.setTextColor(13, 71, 161);
                doc.setFont("helvetica", "bold");
                doc.text(concepto.nombre, margen, y);
                y += 12;

                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.setFont("helvetica", "normal");

                let seleccionesCount = 0;

                // Mostrar las 5 ideas que forman este concepto
                for (let i = 0; i < concepto.grupos.length; i++) {
                    const grupoKey = `pastel_grupo${concepto.grupos[i]}`;
                    const seleccion = data[grupoKey] || t('no_selection');

                    seleccionesCount++;
                    tieneConceptos = true;

                    doc.text(`${i + 1}. ${seleccion}`, margen + 10, y);
                    y += 10;

                    if (y > 280) {
                        doc.addPage();
                        y = margen;
                    }
                }

                y += 10;
            }

            if (!tieneConceptos) {
                doc.text(t('no_concepts_formed'), margen, y);
                y += 10;
            }

            y += 15;

            // 8. EVALUACIÃ“N DE CONCEPTOS FORMADOS
            if (y > 220) {
                doc.addPage();
                y = margen;
            }

            doc.setFontSize(16);
            doc.setTextColor(21, 101, 192);
            doc.setFont("helvetica", "bold");
            doc.text(t('evaluation_concepts_formed'), margen, y);
            y += 15;

            let tieneEvalConceptos = false;

            for (let conc = 1; conc <= 3; conc++) {
                let tieneDatos = false;
                for (let i = 1; i <= 4; i++) {
                    const key = `ca${(conc - 1) * 4 + i}`;
                    if (data[key]) {
                        tieneDatos = true;
                        tieneEvalConceptos = true;
                        break;
                    }
                }

                if (tieneDatos) {
                    if (y > 260) {
                        doc.addPage();
                        y = margen;
                    }

                    doc.setFontSize(14);
                    doc.setTextColor(13, 71, 161);
                    doc.setFont("helvetica", "bold");
                    doc.text(`${t('concept_formed')} ${conc}`, margen, y);
                    y += 12;

                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont("helvetica", "normal");

                    let total = 0;
                    for (let i = 1; i <= 4; i++) {
                        const key = `ca${(conc - 1) * 4 + i}`;
                        const calif = parseFloat(data[key]) || 0;
                        const peso = parseFloat(data[`peso${i}`]) || 0;
                        total += calif * peso;
                    }

                    doc.text(`${t('final_score')}: ${total.toFixed(2)}`, margen + 10, y);
                    y += 12;

                    data[`resultado${conc + 3}`] = total.toFixed(2);
                }
            }

            if (!tieneEvalConceptos) {
                doc.text(t('no_evaluation_concepts'), margen, y);
                y += 10;
            }

            y += 15;

            // 9. MEJOR CONCEPTO SELECCIONADO - COMPLETO
            if (y > 230) {
                doc.addPage();
                y = margen;
            }

            doc.setFontSize(16);
            doc.setTextColor(21, 101, 192);
            doc.setFont("helvetica", "bold");
            doc.text(t('best_concept_selected'), margen, y);
            y += 15;

            // Buscar el mejor concepto
            let mejorIndice = -1;
            let mejorPuntuacion = -1;

            for (let i = 4; i <= 6; i++) {
                const puntuacion = parseFloat(data[`resultado${i}`]) || 0;
                if (puntuacion > mejorPuntuacion) {
                    mejorPuntuacion = puntuacion;
                    mejorIndice = i - 3;
                }
            }

            if (mejorIndice > 0 && mejorPuntuacion > 0) {

                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.setFont("helvetica", "normal");
                doc.text(`${t('score_obtained')}: ${mejorPuntuacion.toFixed(2)}`, margen, y);
                y += 12;

                // MOSTRAR QUÃ‰ FORMA EL MEJOR CONCEPTO
                doc.setFontSize(14);
                doc.setTextColor(21, 101, 192);
                doc.setFont("helvetica", "bold");
                doc.text(t('composition_winner'), margen, y);
                y += 12;

                // Determinar quÃ© grupos forman este concepto
                let gruposDelConcepto = [];
                if (mejorIndice === 1) {
                    gruposDelConcepto = [1, 4, 7, 10, 13];
                } else if (mejorIndice === 2) {
                    gruposDelConcepto = [2, 5, 8, 11, 14];
                } else {
                    gruposDelConcepto = [3, 6, 9, 12, 15];
                }

                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.setFont("helvetica", "normal");

                // Mostrar cada una de las 5 ideas que forman el concepto
                for (let i = 0; i < gruposDelConcepto.length; i++) {
                    const grupoKey = `pastel_grupo${gruposDelConcepto[i]}`;
                    const seleccion = data[grupoKey] || t('idea_not_selected');

                    if (y > 270) {
                        doc.addPage();
                        y = margen;
                    }

                    doc.text(`${i + 1}. ${seleccion}`, margen + 10, y);
                    y += 10;
                }

            } else {
                doc.text(t('no_best_concept'), margen, y);
                y += 10;
            }

            y += 20;

            // 10. PREVENCIÃ“N DE RIESGOS - COMPLETO
            if (y > 220) {
                doc.addPage();
                y = margen;
            }

            doc.setFontSize(16);
            doc.setTextColor(21, 101, 192);
            doc.setFont("helvetica", "bold");
            doc.text(t('risk_prevention'), margen, y);
            y += 15;

            let tienePrevencion = false;

            for (let i = 1; i <= 3; i++) {
                // Verificar si hay datos para esta prevenciÃ³n
                const falla = data[`fallaPotencial${i}`];
                const efecto = data[`efecto${i}`];
                const sev = data[`sev${i}`];
                const ocu = data[`ocu${i}`];
                const riesgo = data[`riesgo${i}`];
                const accionReal = data[`accionReal${i}`];
                const responsable = data[`responsable${i}`];
                const fechaCell = data[`fechaCell${i}`];
                const accionTom = data[`accionTom${i}`];
                const fecha = data[`fecha${i}`];

                // Verificar si hay al menos un dato
                if (falla || efecto || sev || ocu || riesgo || accionReal || responsable || fechaCell || accionTom || fecha) {
                    tienePrevencion = true;

                    if (y > 240) {
                        doc.addPage();
                        y = margen;
                    }

                    doc.setFontSize(14);
                    doc.setTextColor(13, 71, 161);
                    doc.setFont("helvetica", "bold");
                    doc.text(`${t('prevention')} ${i}`, margen, y);
                    y += 12;

                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont("helvetica", "normal");

                    // Mostrar TODOS los campos disponibles
                    if (falla) {
                        doc.text(`${t('potential_failure')} ${falla}`, margen + 10, y);
                        y += 10;
                    }

                    if (efecto) {
                        doc.text(`${t('effect')} ${efecto}`, margen + 10, y);
                        y += 10;
                    }

                    if (sev) {
                        doc.text(`${t('severity')} ${sev}`, margen + 10, y);
                        y += 10;
                    }
            
                    if (ocu) {
                        doc.text(`${t('occurrence')} ${ocu}`, margen + 10, y);
                        y += 10;
                    }
            
                    if (riesgo) {
                        doc.text(`${t('risk')} ${riesgo}`, margen + 10, y);
                        y += 10;
                    }       
            
                    if (accionReal) {
                        doc.text(`${t('actions_to_take')} ${accionReal}`, margen + 10, y);
                        y += 10;
                    }
            
                    if (responsable) {
                        doc.text(`${t('responsible')} ${responsable}`, margen + 10, y);
                        y += 10;
                    }
            
                    if (fechaCell) {
                        doc.text(`${t('today_date')} ${fechaCell}`, margen + 10, y);
                        y += 10;
                    }
            
                    if (accionTom) {
                        doc.text(`${t('action_taken')} ${accionTom}`, margen + 10, y);
                        y += 10;
                    }
            
                    if (fecha) {
                        doc.text(`${t('action_date')} ${fecha}`, margen + 10, y);
                        y += 10;
                    }
            
                    y += 10;
            
                    if (y > 280) {
                        doc.addPage();
                        y = margen;
                    }
                }
            }
    
            if (!tienePrevencion) {
                doc.text(t('no_prevention_data'), margen, y);
                y += 10;
            }
    
            y += 15;

            // 11. PLAN DE ACCIÃ“N
            if (y > 230) {
                doc.addPage();
                y = margen;
            }
    
            doc.setFontSize(16);
            doc.setTextColor(21, 101, 192);
            doc.setFont("helvetica", "bold");
            doc.text(t('action_plan'), margen, y);
            y += 15;
    
            let tieneTareas = false;
    
            // Tareas 1-15
            doc.setFontSize(14);
            doc.setTextColor(13, 71, 161);
            doc.setFont("helvetica", "bold");
            doc.text(t('tasks_1_15'), margen, y);
            y += 12;
    
            for (let i = 1; i <= 15; i++) {
                const tarea = data[`tarea${i}`];
                const persona = data[`persona${i}`];
        
                if (tarea || persona) {
                    tieneTareas = true;
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont("helvetica", "normal");
                    doc.text(`${i}. ${persona || ""} - ${tarea || ""}`, margen + 10, y);
                    y += 10;
            
                    if (y > 280) {
                        doc.addPage();
                        y = margen;
                    }
                }
            }
    
            y += 15;
    
            // Tareas 16-30
            if (y > 250) {
                doc.addPage();
                y = margen;
            }
    
            doc.setFontSize(14);
            doc.setTextColor(13, 71, 161);
            doc.setFont("helvetica", "bold");
            doc.text(t('tasks_16_30'), margen, y);
            y += 12;
    
            for (let i = 16; i <= 30; i++) {
                const tarea = data[`tarea${i}`];
                const persona = data[`persona${i}`];
        
                if (tarea || persona) {
                    tieneTareas = true;
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont("helvetica", "normal");
                    doc.text(`${i}. ${persona || ""} - ${tarea || ""}`, margen + 10, y);
                    y += 10;
            
                    if (y > 280) {
                        doc.addPage();
                        y = margen;
                    }
                }
            }
    
            if (!tieneTareas) {
                doc.text(t('no_tasks'), margen, y);
                y += 10;
            }

            // 12. FIN DEL DOCUMENTO
            const finalY = doc.internal.pageSize.height - 20;
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`${t('document_generated')} ${hoy}`, anchoPagina / 2, finalY, { align: "center" });

            // Guardar PDF
            pdfBlob = doc.output('blob');
            document.getElementById('filenameDisplay').textContent = filename;

            // Descarga automÃ¡tica
            const url = URL.createObjectURL(pdfBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // BotÃ³n para descargar nuevamente
        document.getElementById('downloadAgainBtn').addEventListener('click', () => {
            if (pdfBlob) {
                const url = URL.createObjectURL(pdfBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            } else {
                generarPDF();
            }
        });

        // Generar PDF al cargar
        window.onload = function() {
            console.log("Generando PDF...");
            setTimeout(generarPDF, 500);
        };

                // Configurar el selector de idioma despuÃ©s de cargar lang.js
        document.addEventListener('DOMContentLoaded', function() {
            const langSelector = document.getElementById('languageSelector');
            if (langSelector) {
                const currentLang = localStorage.getItem('preferredLanguage') || 'es';
                langSelector.value = currentLang;
                
                langSelector.addEventListener('change', function() {
                    setLanguage(this.value);
                    updateThemeButton(); // Actualizar tooltip en nuevo idioma
                });
            }
            
            // ========== CONFIGURAR TEMA OSCURO ==========
            const themeToggle = document.getElementById('themeToggle');
            const currentTheme = localStorage.getItem('theme') || 'light';
            
            // Aplicar tema guardado
            document.documentElement.setAttribute('data-theme', currentTheme);
            updateThemeButton();
            
            // Cambiar tema al hacer clic
            if (themeToggle) {
                themeToggle.addEventListener('click', function() {
                    const current = document.documentElement.getAttribute('data-theme');
                    const newTheme = current === 'dark' ? 'light' : 'dark';
                    
                    document.documentElement.setAttribute('data-theme', newTheme);
                    localStorage.setItem('theme', newTheme);
                    updateThemeButton();
                });
            }
            
            // Actualizar icono del botÃ³n
            function updateThemeButton() {
                if (!themeToggle) return;
                
                const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                
                if (currentTheme === 'dark') {
                    themeToggle.textContent = 'â˜€ï¸';
                    themeToggle.title = 'Cambiar a modo claro';
                    // Actualizar tooltip traducido si estÃ¡ disponible
                    if (typeof t === 'function') {
                        themeToggle.title = t('theme_light') || 'Cambiar a modo claro';
                    }
                } else {
                    themeToggle.textContent = 'ðŸŒ™';
                    themeToggle.title = 'Cambiar a modo oscuro';
                    if (typeof t === 'function') {
                        themeToggle.title = t('theme_dark') || 'Cambiar a modo oscuro';
                    }
                }
            }
        });
    </script>
</body>
</html>